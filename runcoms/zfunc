#
# functions
#

# Search ghq list
peco-src () {
    local repo=$(ghq list | peco --query "$LBUFFER")
    if [ -n "$repo" ]; then
        repo=$(ghq list --full-path --exact $repo)
        BUFFER="cd ${repo}"
        zle accept-line
    fi
    zle clear-screen
}
zle -N peco-src
bindkey '^]' peco-src

# Search history
peco-history-selection () {
    BUFFER=$(\history -n -r 1 | peco --query "$LBUFFER")
    CURSOR=$#BUFFER
    zle clear-screen
}

zle -N peco-history-selection
bindkey '^R' peco-history-selection

autoload -Uz promptinit
promptinit
prompt pure

aws-session-token () {
    output=$(aws sts get-session-token)
    export AWS_ACCESS_KEY_ID=$(echo $output | jq -r .Credentials.AccessKeyId)
    export AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r .Credentials.SecretAccessKey)
    export AWS_SESSION_TOKEN=$(echo $output | jq -r .Credentials.SessionToken)
}

switch-role () {
   account_id=XXXXXXXXXXXX
   role_name=YYYYYYYYYYYYY
   role_arn="arn:aws:iam::${account_id}:role/${role_name}"

   output=$(aws sts assume-role --role-arn ${role_name} --role-session ${role_name})
   aws sts assume-role --role-arn ${role_arn} --role-session session
   export AWS_ACCESS_KEY_ID=$(echo $output | jq -r .Credentials.AccessKeyId)
   export AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r .Credentials.SecretAccessKey)
   export AWS_SESSION_TOKEN=$(echo $output | jq -r .Credentials.SessionToken)
}

killport () {
  lsof -ti tcp:"$1" | xargs -r kill -9
}
